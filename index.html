
<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="description" content="">
        <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
        <meta name="generator" content="Hugo 0.88.1">
        <title>SWAPP</title>
        <script src="https://use.fontawesome.com/41666ba71b.js"></script>
    
        <!--<link rel="canonical" href="https://getbootstrap.com/docs/4.6/examples/album/"> -->      
    
        <!-- Bootstrap core CSS -->
    <link href="assets/dist/css/bootstrap.min.css" rel="stylesheet">   
    
        <style>
          .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
          }
    
          @media (min-width: 768px) {
            .bd-placeholder-img-lg {
              font-size: 3.5rem;
            }
          }
        </style>
    
        
        <!-- Custom styles for this template -->
        <link href="album.css" rel="stylesheet">
      </head>
      <body>
        
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-xl">
              <a class="navbar-brand" href="/">
                  <span>S W A P P</span>
                  <img src="../SWAPI/images/icon-starwars.svg">
              </a>
              <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExample07XL" aria-controls="navbarsExample07XL" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
          
              <div class="collapse navbar-collapse" id="navbarsExample07XL">
                <ul class="navbar-nav mr-auto"></ul>
                <form class="form-inline my-2 my-md-0">
                  <input id="searchField" class="form-control" type="text" placeholder="Search" aria-label="Search">
                </form>
              </div>
            </div>
          </nav>
            
    </header>
    
    <main role="main">
    <!-- Джумботрон -->
        <section class="jumbotron jumbotron-fluid text-center">
            <div class="container">
                <h1>Star War Universe</h1>
                <p class="lead text-muted">All the Star Wars data you've ever wanted:
                    Planets, Spaceships, Vehicles, People, Films and Species
                    from all 9 Star Wars films</p>            
                <p class="lead text-muted">Now with The Force Awakens data!</p>
            </div>
        </section>

        
    <!-- Сетка персонажей -->
        <div class="album py-5 bg-dark">
            <div class="container">
                <h2>CHARACTERS</h2>   
                <div id="cards-list" class="row"></div>
            </div>


            <!-- Модальное окно -->            
            <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel"></h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div id="modalBody" class="modal-body">

                        </div>
                    </div>
                </div>
            </div>

            <!-- Пагинация -->
            <nav aria-label="pagination" class="pages">
                <ul id="pages" class="pagination justify-content-center"></ul>
            </nav>
        </div>    
    </main>
        
        <footer class="text-muted">
            <div class="container">
                <p class="footer__header">Follow us</p>
                <ul class="footer__list"> 
                    <li class="footer__item">
                        <a href="https://www.pinterest.com" title="SHOPNO in Pinterest"><i class="fa fa-pinterest-p"></i></a>
                    </li>
                    <li class="footer__item">
                        <a href="https://twitter.com" title="SHOPNO in Twitter"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li class="footer__item">
                        <a href="https://www.facebook.com" title="SHOPNO in Facebook"><i class="fa fa-facebook"></i></a>
                    </li>
                </ul>
            </div>
        </footer>

        <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha384-VHvPCCyXqtD5DqJeNxl2dtTyhF78xXNXdkwX1CZeRusQfRKp+tA7hAShOK/B/fQ2" crossorigin="anonymous"></script>   
        <script>
            "use strict"
            //отрисовка элемента нумерации страниц
            function printPagesElement(currentPage, pageCount) {
                if (pageCount === 1) {
                    pageList.push(`
                    <li class="page-item">
                        <a id="${pageCount}" class="page-link" href="#">${pageCount}</a>
                    </li>`);
                    let str = pageList.join('');
                    pages.innerHTML = str;
                    document.getElementById(currentPage).closest('li').classList.add('active');
                } else {
                    for (let i = 1; i <= pageCount; i++) {
                    pageList.push(`
                    <li class="page-item">
                        <a id="${i}" class="page-link" href="#">${i}</a>
                    </li>`);    
                    };
                    pageList.push(`
                    <li class="page-item">
                        <a id="next" class="page-link" href="#">NEXT</a>
                    </li>`);
                    pageList.unshift(`
                    <li class="page-item">
                        <a id="prev" class="page-link" href="#" tabindex="-1" aria-disabled="true">PREV</a>
                    </li>`);

                    let str = pageList.join('');
                    pages.innerHTML = str;
                    //alert(typeof(pageCount));
                    if (+currentPage === 1) {
                        document.getElementById('next').closest('li').classList.remove('disabled');
                        document.getElementById('prev').closest('li').classList.add('disabled');
                    } else if (+currentPage === pageCount) {
                        document.getElementById('next').closest('li').classList.add('disabled');
                        document.getElementById('prev').closest('li').classList.remove('disabled');
                    } else {
                        document.getElementById('next').closest('li').classList.remove('disabled');
                        document.getElementById('prev').closest('li').classList.remove('disabled');
                    }
                    document.getElementById(currentPage).closest('li').classList.add('active');                
                }
            }
            
            //async function loadPageData(pageNumb) {
                // cardsList.innerHTML = '';
                // usersInfo.length = 0;
                // pageList.length = 0;
                // pages.innerHTML = '';
                // try {
                //     const responsePage = await fetch(`https://swapi.dev/api/people/?page=${pageNumb}`);
                //     const pageData = await responsePage.json();
                //     const pageCount = Math.ceil(+pageData.count/10);
                //     localStorage.setItem('maxPageCount', JSON.stringify(pageCount)); 
                //     usersInfo = pageData.results;
                //     printPagesElement(pageNumb, pageCount);
                //     showCards();                               
                // } catch(err) {
                //     alert(err)
                // }
            //}

            function toggleActiveStatus(obj, id) {                
                obj.classList.toggle('active');
                document.getElementById(id).closest('li').classList.add('active');
            }
            
            function savePageNumber(currentPageNumb) {
                localStorage.setItem('currentPageNumb', JSON.stringify(currentPageNumb));
            }

            function showCards() {
                let cardsList = document.getElementById('cards-list');
                cardsList.innerHTML = '';
                
                cardsList.innerHTML = usersInfo.map(elem => `
                <div class="col-md-3">
                    <div class="card mb-3 shadow-sm">
                        <img class='charcter_image' src="images/StarWars.jpg">
                        <div class="card-body">
                            <p class="card-text">${elem.name}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group" data-id="${usersInfo.indexOf(elem)}">
                                    <a id='btnDetails' class="btn btn-sm btn-outline-warning" data-toggle="modal" data-target="#exampleModal">Details</a>
                                </div>                                
                            </div>
                        </div>
                    </div>
                </div>`).join('');                
            }
            
            function init() {
                let pageNum = localStorage.getItem('currentPageNumb') || 1;
                console.log(pageNum);                
                loadData('', pageNum);                
            } 

            async function getUserData(userID) {
                let cardBody = document.getElementById('modalBody');

                try {
                    //получение Наименования планеты по url
                    let planetReq = await fetch(usersInfo[userID].homeworld);
                    if (planetReq.ok) {
                        let planet = await planetReq.json();
                        let p = document.createElement('p');
                        p.textContent = `Planet: ${planet.name}`;
                        cardBody.append(p);                    
                    }
                } catch (error) {
                    alert(error)
                }
                
                //вид/раса 
                try {
                    let p = document.createElement('p');
                    if (usersInfo[userID].species.length === 0) {
                        p.textContent = 'Species: unknown';
                    } else {
                        let specReq = await fetch(usersInfo[userID].species[0]);
                        if (specReq.ok) {
                            let species = await specReq.json();
                            let speciesData = species.name+', '+species.classification+', '+species.designation;                            
                            p.textContent = `Species: ${speciesData}`;                            
                        }                      
                    } 
                    cardBody.append(p);                   
                } catch (error) {
                    alert(error)
                }               
                
                //films
                try {
                    let ul = document.createElement('ul');
                    if (usersInfo[userID].films.length === 0) {
                        ul.innerHTML = 'Films: unknown';
                    } else {
                        let filmReq = usersInfo[userID].films.map(film => fetch(film));
                        Promise.all(filmReq)
                        .then(respFilms => Promise.all(respFilms.map(elem => elem.json())))
                        .then(function(filmsNames) {
                            let filmsList = filmsNames.map(i => `StarWars. Episode ${i.episode_id}. ${i.title}`);
                            ul.innerHTML = "Films: " + filmsList.map(elem => `<li class="data-list">${elem}</li>`).join('');                                      
                        }); 
                    }
                    cardBody.append(ul);                    
                } catch (error) {
                    alert(error)
                }

                //starships
                try {
                    let ul = document.createElement('ul');
                    if (usersInfo[userID].starships.length === 0) {
                        ul.innerHTML = 'Starships: unknown';
                    } else {                        
                        let ssReq = usersInfo[userID].starships.map(ss => fetch(ss));
                        Promise.all(ssReq)
                        .then(respSS => Promise.all(respSS.map(elem => elem.json())))
                        .then(function(ssNames) {
                            let ssList = ssNames.map(el => `${el.name} => model: ${el.model} / class: ${el.starship_class}`);
                            ul.innerHTML = "Starships: " + ssList.map(elem => `<li class="data-list">${elem}</li>`).join('');
                        }); 
                    } 
                    cardBody.append(ul);                   
                } catch (error) {
                    alert(error)
                }

                //vehicles
                try {
                    let ul = document.createElement('ul');
                    if (usersInfo[userID].vehicles.length === 0) {
                        ul.innerHTML = 'Vehicles: unknown';
                    } else {                        
                        let vReq = usersInfo[userID].vehicles.map(v => fetch(v));
                        Promise.all(vReq)
                        .then(respV => Promise.all(respV.map(elem => elem.json())))
                        .then(function(vNames) {
                            let vehiclesList = vNames.map(el => `${el.name} => model: ${el.model} / class: ${el.vehicle_class}`);
                            ul.innerHTML = "Vehicles:" + vehiclesList.map(elem => `<li class="data-list">${elem}</li>`).join('');                                      
                        }); 
                    }
                    cardBody.append(ul);
                } catch (error) {
                    alert(error)
                }
            }
            
            // async function searchCharacters(req) {                
            //     let serverReq = await fetch(`https://swapi.dev/api/people/?search=${req}`);
            //     let response = await serverReq.json();
            //     usersInfo = response.results;         
            //     if (usersInfo.length > 0) {
            //         let searchPageCount = Math.ceil(+response.count/10);
            //         printPagesElement(1, searchPageCount);
            //         showCards();
            //     } else {
            //         cardsList.innerHTML = '<h5>No results :(</h5>';
            //     }                    
            // }

            // async function loadSearchData(req, pageNumb) {
            //     cardsList.innerHTML = '';
            //     usersInfo.length = 0;
            //     pageList.length = 0;
            //     pages.innerHTML = '';
            //     try {
            //         const responsePage = await fetch(`https://swapi.dev/api/people/?search=${req}&page=${pageNumb}`);
            //         const pageData = await responsePage.json();
            //         const pageCount = Math.ceil(+pageData.count/10);
            //         usersInfo = pageData.results;
            //         printPagesElement(pageNumb, pageCount);
            //         showCards();                               
            //     } catch(err) {
            //         alert(err)
            //     }
            // }

            async function loadData(req, pageNumb) {
                cardsList.innerHTML = '';
                usersInfo.length = 0;
                pageList.length = 0;
                pages.innerHTML = '';
                let serverReq = '';
                let respData = '';
                try {
                    // переключение страниц в поисковом запросе
                    if ( (req) && +pageNumb > 1) {
                        serverReq = await fetch(`https://swapi.dev/api/people/?search=${req}&page=${pageNumb}`);
                    // поисковый запрос    
                    }
                    if ( (req) && (!pageNumb) ) {
                        serverReq = await fetch(`https://swapi.dev/api/people/?search=${req}`);
                    // загрузка страниц
                    }
                    if ( (req.length === 0) && (+pageNumb >= 1) ) {
                        serverReq = await fetch(`https://swapi.dev/api/people/?page=${pageNumb}`);
                    } 
                    respData = await serverReq.json();
                    const pageCount = Math.ceil(+respData.count/10); 
                    //localStorage.setItem('maxPageCount', JSON.stringify(pageCount));           
                    if (respData.results.length > 0) {
                        usersInfo = respData.results;
                        //поиск
                        if (!pageNumb) {
                            printPagesElement(1, pageCount); 
                        } else {
                            printPagesElement(pageNumb, pageCount);
                        }                
                        showCards();                               
                    } else {
                        cardsList.innerHTML = '<h5>No results :(</h5>';
                    }            
                } catch(err) {
                    alert(err);
                    cardsList.innerHTML = '<h5>UPS!...Something is wrong...</h5>';
                }
            }
            
            
            //////  main  //////

            let usersInfo = [];
            let pageList = []; // нужен для отрисовки страничек
            let pages = document.getElementById('pages');
            let cardsList = document.getElementById('cards-list');
            let exampleModal = document.getElementById("exampleModal");
            let search = document.querySelector('form');
            let searchField = document.getElementById('searchField');          
            
            init();

            let pagesCount = JSON.parse(localStorage.getItem('maxPageCount'));
                       
            //переключение страниц
            pages.addEventListener('click', function(event) {
                let activePage = document.querySelector('.page-item.active');
                let chosenPage = event.target.id;
                
                if (chosenPage === 'prev') {
                    chosenPage = +activePage.firstElementChild.id - 1;
                    //число
                    if (chosenPage !== 1) {
                        toggleActiveStatus(activePage, chosenPage);                        
                    } else {
                        toggleActiveStatus(activePage, chosenPage);
                        document.getElementById('prev').closest('li').classList.add('disabled');                        
                    }                    
                }
                if (chosenPage === 'next') {
                    chosenPage = +activePage.firstElementChild.id + 1;
                    //число
                    if (chosenPage === pagesCount) {                        
                        toggleActiveStatus(activePage, chosenPage);
                        document.getElementById('next').closest('li').classList.add('disabled');
                    } else {
                        toggleActiveStatus(activePage, chosenPage);
                        document.getElementById('prev').closest('li').classList.remove('disabled');
                    }            
                }
                toggleActiveStatus(activePage, +chosenPage);
                if (searchField.value) {
                    loadData(searchField.value, +chosenPage);
                } else {
                    loadData('', +chosenPage);                    
                }
                savePageNumber(+chosenPage);
            });

            //нажатие кнопки Details
            cardsList.addEventListener('click', function(event) {
                if (event.target.id === 'btnDetails') {
                    let btnID = event.target.closest('div').getAttribute('data-id');
                    let cardBody = document.getElementById('modalBody');
                    getUserData(btnID);                                      
                    
                    let modalUserName = document.getElementById('exampleModalLabel');
                    modalUserName.textContent = usersInfo[btnID].name;
                    cardBody.innerHTML = '';
                    
                    cardBody.innerHTML = `
                    <p>Birth year: ${usersInfo[btnID].birth_year}</p>
                    <p>Gender: ${usersInfo[btnID].gender}</p>
                    <p>Skin color: ${usersInfo[btnID].skin_color}</p>
                    <p>Eye color: ${usersInfo[btnID].eye_color}</p>
                    <p>Hair color: ${usersInfo[btnID].hair_color}</p>
                    <p>Height: ${usersInfo[btnID].height}</p>
                    <p>Mass: ${usersInfo[btnID].mass}</p>
                    `
                }                
            });

            //search            
            search.addEventListener('submit', function(event) {                
                event.preventDefault();
                let lookup = searchField.value;
                //console.log(lookup);
                // cardsList.innerHTML = '';
                // pages.innerHTML = '';
                // usersInfo.length = 0;
                // pageList.length = 0;                
                loadData(lookup, '');                                
            });
        </script>
    </body>
</html>
